
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h5" Align="Align.Center">Edit subsystem's data</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudTabs Outlined="true" Rounded="true" Centered="true" ApplyEffectsToContainer="true" Color="@Color.Default">

                    <MudTabPanel Text="Subsystem details">
                        <EditForm Model="@Subsystem" OnValidSubmit="OnValidSubmit" id="formId">
                            <DataAnnotationsValidator />
                            <MudGrid Style="padding: 20px;">
                                <MudItem xs="12">
                                    <MudField Label="Type of subsystem *" ReadOnly="true" Variant="Variant.Outlined">@TypeOfSubsystem</MudField>
                                </MudItem>
                                <MudItem xs="12">
                                    <MudSelect @bind-Value="Subsystem.OperationPrinciple" T="OperationPrincipleModel" Label="Operation principle *" Variant="Variant.Outlined" Format="F2" ToStringFunc="@operationPrincipleToString">
                                        @foreach (var item in operationPrinciples)
                                        {
                                            <MudSelectItem T="OperationPrincipleModel" Value="@(item)" />
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12">
                                    <MudSelect @bind-Value="Subsystem.Category" T="CategoryModel" Label="Category *" Variant="Variant.Outlined" Format="F2" ToStringFunc="@categoryToString">
                                        @foreach (var item in categories)
                                        {
                                            <MudSelectItem T="CategoryModel" Value="@(item)" />
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="12">
                                    <hr />
                                </MudItem>
                                <MudItem xs="3">
                                    <MudField Label="PL result" ReadOnly="true" Variant="Variant.Outlined">@Subsystem.PLresult</MudField>
                                </MudItem>
                                <MudItem xs="3">
                                    <MudField Label="CCF valid" ReadOnly="true" Variant="Variant.Outlined">@Subsystem.ValidCCF</MudField>
                                </MudItem>
                                <MudItem xs="3">
                                    <MudField Label="MTTFd result" ReadOnly="true" Variant="Variant.Outlined">@Subsystem.MttFdResult</MudField>
                                </MudItem>
                                <MudItem xs="3">
                                    <MudField Label="DC result" ReadOnly="true" Variant="Variant.Outlined">@Subsystem.DCresult</MudField>
                                </MudItem>
                            </MudGrid>
                        </EditForm>
                    </MudTabPanel>

                    <MudTabPanel Text="CCF">
                        <MudGrid Style="padding: 20px;">
                            <MudItem xs="12">
                                <MudTable T="CCFModel" MultiSelection="true" @bind-SelectedItems="@Subsystem.SelectedCCFs" Items="@CCFs" Dense="true" Hover="true" FixedHeader="true" Outlined="true">
                                    <ColGroup>
                                        <col style="width:5%;" /> Checkbox
                                        <col style="width:15%;" /> Type
                                        <col style="width:75%;" /> Description
                                        <col style="width:5%;" /> Points
                                    </ColGroup>
                                    <HeaderContent>
                                        <MudTh>Type</MudTh>
                                        <MudTh>Description</MudTh>
                                        <MudTh>Points</MudTh>
                                    </HeaderContent>
                                    <RowTemplate Context="tableContext">
                                        <MudTd DataLabel="Name">@tableContext.Type</MudTd>
                                        <MudTd DataLabel="Name">@tableContext.Description</MudTd>
                                        <MudTd DataLabel="Name">@tableContext.Points</MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>

                    <MudTabPanel Text="Elements">
                        <MudGrid Style="padding: 20px;">
                            @if (Subsystem.Category.Channels == 1)
                            {
                                <MudItem xs="3" />
                                <MudItem xs="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">1. Element</MudText>
                                    <ElementPL Model="element1" MTTFds="MTTFds" Producers="producers" DCs="DCs" />
                                </MudItem>
                                <MudItem xs="3" />
                            }
                            else
                            {
                                <MudItem xs="12">
                                    <MudText Align="Align.Center">
                                        <MudCheckBox @bind-Checked="equalElements" Color="Color.Primary" Style="padding: 0px;">Both elements are the same</MudCheckBox>
                                    </MudText>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">1. Element</MudText>
                                    <ElementPL Model="element1" MTTFds="MTTFds" Producers="producers" DCs="DCs" />
                                </MudItem>
                                <MudItem xs="6">
                                    <MudText Typo="Typo.h6" Align="Align.Center">2. Element</MudText>
                                    <ElementPL Model="@(equalElements == true ? element1 : element2)" MTTFds="MTTFds" Producers="producers" DCs="DCs" />
                                </MudItem>
                            }
                        </MudGrid>
                    </MudTabPanel>

                </MudTabs>
            </MudItem>
            <MudItem xs="6">
                <MudButton Variant="Variant.Filled" OnClick="Cancel" Style="width:100%; margin-bottom: 10px;">Cancel</MudButton>
            </MudItem>
            <MudItem xs="6">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit" Style="width:100%; margin-bottom: 10px;">Save</MudButton>
            </MudItem>
        </MudGrid>   
    </DialogContent>
</MudDialog>

@code {

    [Inject]
    private CodeListFacade codeListFacade { get; set; }

    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public SubsystemDetailModelPL Subsystem { get; set; }

    [Parameter]
    public string TypeOfSubsystem { get; set; }

    private Func<CategoryModel, string> categoryToString = cat => cat.Label;
    private Func<OperationPrincipleModel, string> operationPrincipleToString = op => op.Name;

    private bool equalElements = true;

    private ElementDetailModelPL element1 = new();
    private ElementDetailModelPL element2 = new();

    private ICollection<ProducerModel> producers = new List<ProducerModel>();
    private ICollection<DCModel> DCs = new List<DCModel>();
    private ICollection<MTTFdModel> MTTFds = new List<MTTFdModel>();
    private ICollection<TypeOfSubsystemModel> typeOfSubsystems = new List<TypeOfSubsystemModel>();
    private ICollection<CategoryModel> categories = new List<CategoryModel>();
    private ICollection<CCFModel> CCFs = new List<CCFModel>();
    private ICollection<OperationPrincipleModel> operationPrinciples = new List<OperationPrincipleModel>();

    protected override async Task OnInitializedAsync()
    {
        typeOfSubsystems = await codeListFacade.GetAllTypeOfSubsystemsAsync();
        producers = await codeListFacade.GetAllProducersAsync();
        MTTFds = await codeListFacade.GetAllMTTFdsAsync();
        DCs = await codeListFacade.GetAllDCsAsync();
        categories = await codeListFacade.GetAllCategoriesAsync();
        CCFs = await codeListFacade.GetAllCCFsAsync();
        operationPrinciples = await codeListFacade.GetAllOperationPrinciplesAsync();
    }

    private void OnValidSubmit()
    {
        // TODO: priradit typ subsystemu
        // TODO: ak su elementy rovnake tak nakopirovat element1 do element2


        Submit();
    }

    void Submit() => MudDialog.Close(DialogResult.Ok(true));
    void Cancel() => MudDialog.Cancel();

}

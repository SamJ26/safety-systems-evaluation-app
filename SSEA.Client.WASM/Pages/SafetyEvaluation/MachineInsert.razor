@page "/safetyEvaluation/machineInsert"

@layout MainLayout

@attribute [Authorize]

@* TODO: 1. add data validation to all fields in form *@

<MudContainer MaxWidth="MaxWidth.Large" Style="padding-top: 10px;">
    <MudCard Elevation="3">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Create new machine</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudIconButton @onclick="ClearData" Icon="@Icons.Material.Filled.Clear" Color="Color.Primary" Disabled="@(saved || tabs.ActivePanelIndex != 0)" />
                <MudIconButton @onclick="EditData" Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Disabled="@(!onlyForReading)"/>
                <MudIconButton ButtonType="ButtonType.Submit" Icon="@Icons.Material.Filled.Save" Color="Color.Primary" form="formId" Disabled="@(onlyForReading || tabs.ActivePanelIndex != 0)" />
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudTabs @ref="tabs" ActivePanelIndexChanged="@(() => StateHasChanged())" Outlined="true" Rounded="true" Centered="true" ApplyEffectsToContainer="true" Color="@Color.Default">

                <MudTabPanel Text="Machine details">
                    <EditForm Model="@machine" OnValidSubmit="@OnValidSubmit" id="formId">
                        <DataAnnotationsValidator />
                        <MudGrid Style="padding: 20px;">
                            <MudItem xs="6">
                                <MudTextField @bind-Value="machine.Name" Label="Machine name *" ReadOnly="@onlyForReading" Variant="Variant.Outlined" For="@(() => machine.Name)"></MudTextField>
                            </MudItem>
                            <MudItem xs="6">
                                <MudSelect @bind-Value="machine.MachineType" ReadOnly="@onlyForReading" T="MachineTypeModel" Label="Machine type *" Strict="true" Variant="Variant.Outlined" Format="F2">
                                    @foreach (var item in machineTypes)
                                    {
                                        <MudSelectItem T="MachineTypeModel" Value="@(item)">@item.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="4">
                                <MudSelect @bind-Value="machine.EvaluationMethod" ReadOnly="@onlyForReading" T="EvaluationMethodModel" Label="Evaluation method *" Strict="true" Variant="Variant.Outlined" Format="F2">
                                    @foreach (var item in evaluationMethods)
                                    {
                                        <MudSelectItem T="EvaluationMethodModel" Value="@(item)">@item.Shortcut</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="4">
                                <MudSelect @bind-Value="machine.Producer" ReadOnly="@onlyForReading" T="ProducerModel" Label="Producer *" Strict="true" Variant="Variant.Outlined" Format="F2">
                                    @foreach (var item in producers)
                                    {
                                        <MudSelectItem T="ProducerModel" Value="@(item)">@item.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="4">
                                <MudSelect @bind-Value="machine.Communication" ReadOnly="@onlyForReading" T="bool" Label="Communication *" Strict="true" Variant="Variant.Outlined" Format="F2">
                                    <MudSelectItem T="bool" Value="@(true)">Yes</MudSelectItem>
                                    <MudSelectItem T="bool" Value="@(false)">No</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="machine.Description" ReadOnly="@onlyForReading" T="string" Label="Machine description" Variant="Variant.Outlined" Lines="3" Style="margin-bottom: 25px;" />
                                <hr />
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Outlined="true">
                                    <MudCheckBox @bind-Checked="machine.Hmi" ReadOnly="@onlyForReading">HMI</MudCheckBox>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Outlined="true">
                                    <MudCheckBox @bind-Checked="machine.Plc" ReadOnly="@onlyForReading">PLC</MudCheckBox>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Outlined="true">
                                    <MudCheckBox @bind-Checked="machine.MachineHelp" ReadOnly="@onlyForReading">Machine help</MudCheckBox>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Outlined="true">
                                    <MudCheckBox @bind-Checked="machine.CodeProtection" ReadOnly="@onlyForReading">Code protection</MudCheckBox>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Outlined="true">
                                    <MudCheckBox @bind-Checked="machine.SecurityOfSafetyParts" ReadOnly="@onlyForReading">Security of safety parts</MudCheckBox>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Outlined="true">
                                    <MudCheckBox @bind-Checked="machine.SafetyMasterInPlace" ReadOnly="@onlyForReading">Safety master in place</MudCheckBox>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </EditForm>
                </MudTabPanel>

                <MudTabPanel Text="Access points">
                    <MudGrid Style="padding: 20px;">
                        <MudItem xs="2">
                            <MudButton @onclick="ClearAccessPoints" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Clear" Size="Size.Medium" DisableElevation="true" Style="width: 100%;" Disabled="@onlyForReading">Clear</MudButton>
                        </MudItem>
                        <MudItem xs="8" />
                        <MudItem xs="2">
                            <MudButton @onclick="OpenCreateAccessPointDialog" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Size="Size.Medium" DisableElevation="true" Color="Color.Primary" Style="width: 100%;" Disabled="@onlyForReading">Add</MudButton>
                        </MudItem>
                        <MudItem xs="12" Style="padding-top: 0px;">
                            <MudTable T="AccessPointListModel" Items="@machine.AccessPoints" Dense="true" Hover="true" Height="300px" FixedHeader="true" Outlined="true" OnRowClick="@(args => GoToAccessPointDetail(args))">
                                <ColGroup>
                                    <col style="width:40%;" /><!-- Name -->
                                    <col style="width:35%;" /><!-- State -->
                                    <col style="width:20%;" /><!-- Safety functions count -->
                                    <col style="width:5%;" /><!-- Actions -->
                                </ColGroup>
                                <HeaderContent>
                                    <MudTh>Name</MudTh>
                                    <MudTh>State</MudTh>
                                    <MudTh>Safety functions</MudTh>
                                    <MudTh>Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="tableContext">
                                    <MudTd DataLabel="Name">@tableContext.Name</MudTd>
                                    <MudTd DataLabel="Name">@(tableContext.CurrentState != null ? tableContext.CurrentState.Name : "New - not saved")</MudTd>
                                    <MudTd DataLabel="Name">@tableContext.SafetyFunctionsCount</MudTd>
                                    <MudTd DataLabel="Name">
                                        <MudIconButton @onclick="() => RemoveAccessPoint(tableContext)" Icon="@Icons.Material.Filled.Delete" Disabled="@onlyForReading"></MudIconButton>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Used norms">
                    <MudGrid Style="padding: 20px;">
                        <MudItem xs="2">
                            <MudButton @onclick="ClearNorms" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Clear" Size="Size.Medium" DisableElevation="true" Style="width: 100%;" Disabled="@onlyForReading">Clear</MudButton>
                        </MudItem>
                        <MudItem xs="8" />
                        <MudItem xs="2">
                            <MudButton @onclick="OpenSelectNormsDialog" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Size="Size.Medium" DisableElevation="true" Color="Color.Primary" Style="width: 100%;" Disabled="@onlyForReading">Add</MudButton>
                        </MudItem>
                        <MudItem xs="12" Style="padding-top: 0px;">
                            <MudTable Items="@machine.MachineNorms" Dense="true" Hover="true" Height="300px" FixedHeader="true" Outlined="true">
                                <ColGroup>
                                    <col style="width:40%;" />
                                    <col style="width:20%;" />
                                    <col style="width:10%;" />
                                    <col style="width:15%;" />
                                    <col style="width:15%;" />
                                </ColGroup>
                                <HeaderContent>
                                    <MudTh>Name</MudTh>
                                    <MudTh>Label</MudTh>
                                    <MudTh>Category</MudTh>
                                    <MudTh>Up to date</MudTh>
                                    <MudTh>Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="tableContext">
                                    <MudTd DataLabel="Name">@tableContext.Norm.Name</MudTd>
                                    <MudTd DataLabel="Label">@tableContext.Norm.Label</MudTd>
                                    <MudTd DataLabel="Category">@tableContext.Norm.NormCategory</MudTd>
                                    <MudTd DataLabel="Up to date">@tableContext.Norm.IsValid</MudTd>
                                    <MudTd DataLabel="Name">
                                        <MudIconButton @onclick="() => RemoveNorm(tableContext)" Icon="@Icons.Material.Filled.Delete" Disabled="@onlyForReading"></MudIconButton>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

            </MudTabs>
            @if (showMessage)
            {
                <MudAlert Severity="@messageType" Style="margin-top: 20px;">@message</MudAlert>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {

    [Inject]
    private IDialogService dialogService { get; set; }

    [Inject]
    private MachineFacade machineFacade { get; set; }

    [Inject]
    private CodeListFacade codeListFacade { get; set; }

    [Inject]
    private ILocalStorageService storageService { get; set; }

    [Inject]
    private NavigationManager navigationManager { get; set; }

    private MachineDetailModel machine;

    private bool onlyForReading = false;
    private bool showMessage = false;
    private string message = string.Empty;
    private Severity messageType = Severity.Success;
    private bool saved = false;
    private MudTabs tabs = new MudTabs();

    private readonly string successMessage = "Your machine was saved successfully :)";
    private readonly string errorMessage = "Saving your machine failed :(";

    private ICollection<EvaluationMethodModel> evaluationMethods = new List<EvaluationMethodModel>();
    private ICollection<MachineTypeModel> machineTypes = new List<MachineTypeModel>();
    private ICollection<ProducerModel> producers = new List<ProducerModel>();
    private ICollection<NormModel> norms = new List<NormModel>();

    protected override async Task OnInitializedAsync()
    {
        machine = new MachineDetailModel();
        machine.AccessPoints = new List<AccessPointListModel>();
        machine.MachineNorms = new List<MachineNormModel>();
        evaluationMethods = await codeListFacade.GetAllEvaluationMethodsAsync();
        machineTypes = await codeListFacade.GetAllMachineTypesAsync();
        producers = await codeListFacade.GetAllProducersAsync();
    }

    private async void OpenCreateAccessPointDialog()
    {
        AccessPointListModel accessPointModel = new();
        var parameters = new DialogParameters() { ["AccessPoint"] = accessPointModel };
        var dialog = dialogService.Show<CreateAccessPointDialog>("Create access point", parameters);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            machine.AccessPoints.Add(accessPointModel);
        }
        StateHasChanged();
    }

    private async void OpenSelectNormsDialog()
    {
        norms = await codeListFacade.GetAllNormsAsync();
        ICollection<MachineNormModel> selectedNorms = new List<MachineNormModel>();
        var parameters = new DialogParameters() { ["Norms"] = norms, ["MachineId"] = machine.Id, ["SelectedNorms"] = selectedNorms };
        var dialog = dialogService.Show<SelectNormsDialog>("Select norms", parameters, new DialogOptions() { MaxWidth = MaxWidth.Large, FullWidth = true });
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            foreach (var item in selectedNorms)
            {
                machine.MachineNorms.Add(item);
            }
        }
        StateHasChanged();
    }

    // TODO: complete logic
    private async void OnValidSubmit()
    {
        onlyForReading = true;
        var result = await machineFacade.CreateAsync(machine);
        if (result != 0)
        {
            messageType = Severity.Success;
            message = successMessage;
            machine = await machineFacade.GetByIdAsync(result);
            Console.WriteLine(result);
        }
        else
        {
            Console.WriteLine("Error create");
            messageType = Severity.Error;
            message = errorMessage;
        }
        showMessage = true;
        saved = true;
        StateHasChanged();
    }

    private void EditData()
    {
        onlyForReading = false;
        showMessage = false;
    }

    private void ClearData()
    {
        machine.Name = string.Empty;
        machine.MachineType = null;
        machine.EvaluationMethod = null;
        machine.Producer = null;
        machine.Communication = false;
        machine.Description = string.Empty;
        machine.Hmi = false;
        machine.Plc = false;
        machine.MachineHelp = false;
        machine.CodeProtection = false;
        machine.SecurityOfSafetyParts = false;
        machine.SafetyMasterInPlace = false;
        machine.AccessPoints.Clear();
        machine.MachineNorms.Clear();
    }

    private void ClearAccessPoints()
    {
        if (saved)
        {
            // TODO: Remove items from DB
        }
        else
        {
            machine.AccessPoints.Clear();
        }
    }

    private void ClearNorms()
    {
        if (saved)
        {
            // TODO: Remove items from DB
        }
        else
        {
            machine.MachineNorms.Clear();
        }
    }

    private void RemoveAccessPoint(AccessPointListModel accessPoint)
    {
        // Mmachine is already in database -> removing item directly from DB
        if (saved)
        {
            // TODO: call accessPointFacade.Remove(accessPoint.Id);
        }
        // Machine is not saved yet -> removing item from collection on frontend
        else
        {
            machine.AccessPoints.Remove(accessPoint);
        }
        StateHasChanged();
    }

    private void RemoveNorm(MachineNormModel norm)
    {
        // Mmachine is already in database -> removing item directly from DB
        if (saved)
        {
            // TODO: call accessPointFacade.Remove(accessPoint.Id);
        }
        // Machine is not saved yet -> removing item from collection on frontend
        else
        {
            machine.MachineNorms.Remove(norm);
        }
        StateHasChanged();
    }

    // TODO: test functionality
    private void GoToAccessPointDetail(TableRowClickEventArgs<AccessPointListModel> args)
    {
        navigationManager.NavigateTo($"/safetyEvaluation/accessPointDetail/{args.Item.Id}");
    }
}

@page "/safetyEvaluation/machineDetail/{id:int?}" 

@layout MainLayout

@inject IDialogService dialogService
@inject MachineFacade machineFacade
@inject CodeListFacade codeListFacade

@attribute [Authorize]

@* TODO: 1. add data validation to all fields in form *@

<MudContainer MaxWidth="MaxWidth.Large" Style="padding-top: 10px;">
    <EditForm Model="@machineModel" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator />
        <MudCard Elevation="3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@pageDescription</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" />
                    <MudIconButton Icon="@Icons.Material.Filled.Save" Color="Color.Default" />
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>

                    <!-- 1. row - machine name, evaluation method, producer -->
                    <MudItem xs="4">
                        <MudTextField @bind-Value="machineModel.Name" Label="Machine name" Variant="Variant.Outlined" For="@(() => machineModel.Name)"></MudTextField>
                    </MudItem>
                    <MudItem xs="4">
                        <MudSelect @bind-Value="machineModel.EvaluationMethod" T="EvaluationMethodModel" Label="Evaluation method" Strict="true" Variant="Variant.Outlined" Format="F2">
                            @foreach (var item in evaluationMethods)
                            {
                                <MudSelectItem T="EvaluationMethodModel" Value="@(item)">@item.Shortcut</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="4">
                        <MudSelect @bind-Value="machineModel.Producer" T="ProducerModel" Label="Producer" Strict="true" Variant="Variant.Outlined" Format="F2">
                            @foreach (var item in producers)
                            {
                                <MudSelectItem T="ProducerModel" Value="@(item)">@item.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- 2. row - communication, machine type, type of logic -->
                    <MudItem xs="4">
                        <MudSelect @bind-Value="machineModel.Communication" T="bool" Label="Communication" Strict="true" Variant="Variant.Outlined" Format="F2">
                            <MudSelectItem T="bool" Value="@(true)">Yes</MudSelectItem>
                            <MudSelectItem T="bool" Value="@(false)">No</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="4">
                        <MudSelect @bind-Value="machineModel.MachineType" T="MachineTypeModel" Label="Machine type" Strict="true" Variant="Variant.Outlined" Format="F2">
                            @foreach (var item in machineTypes)
                            {
                                <MudSelectItem T="MachineTypeModel" Value="@(item)">@item.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="4">
                        <MudField Label="Type of logic" Variant="Variant.Outlined">@(machineModel.TypeOfLogic != null ? machineModel.TypeOfLogic.Name : "Not selected")</MudField>
                    </MudItem>

                    <!-- 3. row - description -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="machineModel.Description" T="string" Label="Machine description" Variant="Variant.Outlined" Lines="3" />
                    </MudItem>

                    <!-- 4. row - optional parameters -->
                    <MudItem xs="12">
                        <MudExpansionPanels>
                            <MudExpansionPanel>
                                <TitleContent>
                                    <div class="d-flex">
                                        <MudText Align="Align.Center">Optional parameters</MudText>
                                    </div>
                                </TitleContent>
                                <ChildContent>
                                    <hr />
                                    <MudGrid Style="margin-top: 3px;">
                                        <MudItem xs="4">
                                            <MudPaper Outlined="true">
                                                <MudCheckBox @bind-Checked="machineModel.Hmi">HMI</MudCheckBox>
                                            </MudPaper>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudPaper Outlined="true">
                                                <MudCheckBox @bind-Checked="machineModel.Plc">PLC</MudCheckBox>
                                            </MudPaper>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudPaper Outlined="true">
                                                <MudCheckBox @bind-Checked="machineModel.MachineHelp">Machine help</MudCheckBox>
                                            </MudPaper>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudPaper Outlined="true">
                                                <MudCheckBox @bind-Checked="machineModel.CodeProtection">Code protection</MudCheckBox>
                                            </MudPaper>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudPaper Outlined="true">
                                                <MudCheckBox @bind-Checked="machineModel.SecurityOfSafetyParts">Security of safety parts</MudCheckBox>
                                            </MudPaper>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudPaper Outlined="true">
                                                <MudCheckBox @bind-Checked="machineModel.SafetyMasterInPlace">Safety master in place</MudCheckBox>
                                            </MudPaper>
                                        </MudItem>
                                    </MudGrid>
                                </ChildContent>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    </MudItem>

                    <!-- 5. row - table with access points -->
                    <MudItem xs="12">
                        <MudTable Items="@machineModel.AccessPoints" Dense="true" Hover="true" Height="300px" FixedHeader="true">
                            <ToolBarContent>
                                <MudText Typo="Typo.h6">Access points</MudText>
                                <MudToolBarSpacer />
                                <MudTextField @bind-Value="searchAccessPoint" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                                <MudButton @onclick="OpenCreateAccessPointDialog" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" IconColor="Color.Primary" Size="Size.Medium" DisableElevation="true" Style="margin-left: 20px; margin-top: 11px; margin-right: 5px;">Add</MudButton>
                            </ToolBarContent>
                            <ColGroup>
                                <col style="width:35%;" />
                                <col style="width:30%;" />
                                <col style="width:20%;" />
                                <col style="width:15%;" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Name</MudTh>
                                <MudTh>State</MudTh>
                                <MudTh>Safety functions</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="tableContext">
                                <MudTd DataLabel="Name">@tableContext.Name</MudTd>
                                <MudTd DataLabel="Name">@(tableContext.CurrentState != null ? tableContext.CurrentState.Name : "New - not saved")</MudTd>
                                <MudTd DataLabel="Name">@tableContext.SafetyFunctionsCount</MudTd>
                                <MudTd DataLabel="Name">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Disabled="accessPointDeleteDisabled"></MudIconButton>
                                    <MudIconButton Icon="@Icons.Material.Filled.ImageSearch" Disabled="accessPointNavigationDisabled"></MudIconButton>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudItem>

                    <!-- 6. row - table with used norms -->
                    <MudItem xs="12">
                        <MudTable Items="@machineModel.MachineNorms" Dense="true" Hover="true" Height="300px" FixedHeader="true">
                            <ToolBarContent>
                                <MudText Typo="Typo.h6">Norms used for this machine</MudText>
                                <MudToolBarSpacer />
                                <MudTextField @bind-Value="searchNorm" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                                <MudButton @onclick="OpenSelectNormsDialog" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" IconColor="Color.Primary" Size="Size.Medium" DisableElevation="true" Style="margin-left: 20px; margin-top: 11px; margin-right: 5px;">Add</MudButton>
                            </ToolBarContent>
                            <ColGroup>
                                <col style="width:40%;" />
                                <col style="width:20%;" />
                                <col style="width:10%;" />
                                <col style="width:15%;" />
                                <col style="width:15%;" />
                            </ColGroup>
                            <HeaderContent>
                                <MudTh>Name</MudTh>
                                <MudTh>Label</MudTh>
                                <MudTh>Category</MudTh>
                                <MudTh>Up to date</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="tableContext">
                                <MudTd DataLabel="Name">@tableContext.Norm.Name</MudTd>
                                <MudTd DataLabel="Label">@tableContext.Norm.Label</MudTd>
                                <MudTd DataLabel="Category">@tableContext.Norm.NormCategory</MudTd>
                                <MudTd DataLabel="Up to date">@tableContext.Norm.IsValid</MudTd>
                                <MudTd DataLabel="Name">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudItem>

                </MudGrid>
            </MudCardContent>
            <MudCardActions>
                <MudGrid>
                    <MudItem xs="6" Style="padding-left: 21px; padding-bottom: 20px; padding-top: 5px;">
                        <MudButton Variant="Variant.Filled" Style="width:100%;">Edit</MudButton>
                    </MudItem>
                    <MudItem xs="6" Style="padding-right: 21px; padding-bottom: 20px; padding-top: 5px;">
                        <MudButton Variant="Variant.Filled" Style="width:100%;" ButtonType="ButtonType.Submit">Save</MudButton>
                    </MudItem>
                </MudGrid>
            </MudCardActions>
        </MudCard>
    </EditForm>
</MudContainer>

@code {

    [Parameter]
    public int Id { get; set; }

    private MachineDetailModel machineModel;

    private string pageDescription;
    private string searchAccessPoint = string.Empty;
    private string searchNorm = string.Empty;
    private bool accessPointDeleteDisabled = true;
    private bool accessPointNavigationDisabled = false;

    private ICollection<EvaluationMethodModel> evaluationMethods = new List<EvaluationMethodModel>();
    private ICollection<MachineTypeModel> machineTypes = new List<MachineTypeModel>();
    private ICollection<ProducerModel> producers = new List<ProducerModel>();
    private ICollection<NormModel> norms = new List<NormModel>();

    protected override async Task OnInitializedAsync()
    {
        if (Id == 0)
        {
            machineModel = new MachineDetailModel();
            machineModel.AccessPoints = new List<AccessPointListModel>();
            machineModel.MachineNorms = new List<MachineNormModel>();
            pageDescription = "Create";
        }
        else
        {
            machineModel = await machineFacade.GetByIdAsync(Id);
            pageDescription = "Detail";
        }
        evaluationMethods = await codeListFacade.GetAllEvaluationMethodsAsync();
        machineTypes = await codeListFacade.GetAllMachineTypesAsync();
        producers = await codeListFacade.GetAllProducersAsync();
    }

    private async void OpenCreateAccessPointDialog()
    {
        AccessPointListModel accessPointModel = new();
        var parameters = new DialogParameters() { ["AccessPoint"] = accessPointModel };
        var dialog = dialogService.Show<CreateAccessPointDialog>("Create access point", parameters);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            machineModel.AccessPoints.Add(accessPointModel);
        }
        StateHasChanged();
    }

    private async void OpenSelectNormsDialog()
    {
        norms = await codeListFacade.GetAllNormsAsync();
        ICollection<MachineNormModel> selectedNorms = new List<MachineNormModel>();
        var parameters = new DialogParameters() { ["Norms"] = norms, ["MachineId"] = machineModel.Id, ["SelectedNorms"] = selectedNorms };
        var dialog = dialogService.Show<SelectNormsDialog>("Select norms", parameters, new DialogOptions() { MaxWidth = MaxWidth.Large, FullWidth = true });
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            foreach (var item in selectedNorms)
            {
                machineModel.MachineNorms.Add(item);
            }
        }
        StateHasChanged();
    }

    private async void OnValidSubmit()
    {
        Console.WriteLine("Saving machine model");
        var result = await machineFacade.CreateAsync(machineModel);
    }
}
